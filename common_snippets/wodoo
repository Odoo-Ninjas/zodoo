ENV WODOO_SRC=/opt/wodoo
ENV WODOO_PIPX_HOME=/opt/wodoo_pipx
ENV WODOO_ENV_DIR=/opt/wodoo_pipx/venvs/wodoo
ENV WODOO_PYTHON=$WODOO_ENV_DIR/bin/python3

RUN #___SNIPPET_APT_INSTALL___ \
     software-properties-common libxml2-dev libxslt1-dev zlib1g-dev python3-dev build-essential
RUN add-apt-repository -y ppa:deadsnakes/ppa
RUN #___SNIPPET_APT_INSTALL___ \
     software-properties-common \
     python3.11 python3.11-venv python3.11-dev
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11

COPY --from=wodoo_src:latest /opt/wodoo "$WODOO_SRC"
RUN chown -R $CURRENT_USER:$CURRENT_USER "$WODOO_SRC"



RUN if [ ! -e "$WODOO_ENV_DIR" ]; then \
     /usr/bin/python3.11 -m venv "$WODOO_ENV_DIR"; \
     $WODOO_PYTHON -m pip install --upgrade pip; \
     $WODOO_PYTHON -m pip install pipx --upgrade;  \
     $WODOO_PYTHON -m pip install setuptools --upgrade;  \
     $WODOO_PYTHON -m pip install wheel --upgrade;  \
fi
RUN $WODOO_PYTHON -mpip install lxml==4.9.3

RUN \
if [ "$ODOO_VERSION"  != '11' ]; then \
     PIPX_HOME="${WODOO_PIPX_HOME}" \
     PIPX_BIN_DIR=/usr/local/bin \ 
     PIP_VERBOSE=1 \
     $WODOO_PYTHON \
     -mpipx \
     install  \
     --force \
     --verbose \
     "$WODOO_SRC" \
     || (echo "=== pipx install failed ===" && \
          cat $WODOO_PIPX_HOME/logs/*.log && \
          exit 1) \

fi

RUN echo 'export PATH=$PATH:$HOME/.local/bin' >> $HOME/.bashrc
RUN chmod a+rw -R "$WODOO_SRC" "$WODOO_PIPX_HOME" "$WODOO_ENV_DIR"